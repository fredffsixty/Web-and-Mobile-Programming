<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Esempi di form</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>

    <meta name='robots' content='noindex, nofollow'>
    <meta name='keywords' content='...'>
    <meta name='description' content='...'>

    <link rel='stylesheet' type='text/css' media='screen' href='form.css'>
    <link rel='icon' sizes='32x32 64x64' href='images/favicon.ico'>

    <style>
        /*
         * classi di forza della password espresse 
         * come colore di background del campo password
         */
        
        .weak {
            background-color: rgba(255, 0, 0, 0.3);
        }
        
        .medium {
            background-color: rgba(255, 165, 0, 0.3);
        }
        
        .strong {
            background-color: rgba(60, 179, 113, 0.3);
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script>
        // questo script esegue il caricamento asincrono dei dati
        // di regioni province e comuni il salvataggio nello storage locale

        fetch('./regioni_province_comuni.json').then(response => {
            console.log(`Status: ${response.status} ${response.statusText}`);
            console.log(`retrieved file: ${response.url}`);
            console.log(`type: ${response.headers.get('Content-Type')}`);
            return response.json(); // questa è una **Promise** di un oggetto json
        }).then(jsondata => {
            localStorage.setItem('regionData', JSON.stringify(jsondata));
        }).catch(error => {
            console.log(error.message);
        });
    </script>
</head>

<body>
    <h1>Esempio di Form</h1>

    <form class="myform" action="#" onsubmit="return recapWindow()">
        <fieldset>
            <legend>Dati anagrafici</legend>
            <label class="mandatory" for="name">Cognome e Nome *</label>
            <input id="name" name="name" type="text" size="40" maxlength="40" required/> &nbsp;&nbsp;&nbsp;

            <input type="radio" id="male" name="gender" value="male" required>
            <label for="male">Uomo</label><br> &thinsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

            <input type="radio" id="female" name="gender" value="female" required>
            <label for="female">Donna</label> &Tab;
            <br /><br />

            <label class="mandatory">Nato a:</label><br><br>

            <label class="mandatory" for="region">Regione *</label>
            <select id="region" name="region" required>
                <option value="-1" selected></option>
                <option value="0">Abruzzo</option>
                <option value="1">Basilicata</option>
                <option value="2">Calabria</option>
                <option value="3">Campania</option>
                <option value="4">Emilia-Romagna</option>
                <option value="5">Friuli-Venezia Giulia</option>
                <option value="6">Lazio</option>
                <option value="7">Liguria</option>
                <option value="8">Lombardia</option>
                <option value="9">Marche</option>
                <option value="10">Molise</option>
                <option value="11">Piemonte</option>
                <option value="12">Puglia</option>
                <option value="13">Sardegna</option>
                <option value="14">Sicilia</option>
                <option value="15">Toscana</option>
                <option value="16">Trentino-Alto Adige</option>
                <option value="17">Umbria</option>
                <option value="18">Valle d'Aosta</option>
                <option value="19">Veneto</option>
              </select>

            <label class="mandatory" for="state">Provincia *</label>
            <select id="state" name="state" required>
                <option value="-1" selected></option>
            </select>

            <br /><br />

            <label class="mandatory" for="town">Comune *</label>
            <select id="town" name="town" required>
                <option value="-1" selected></option>
            </select>

            <br /><br />

            <label class="mandatory" for="birthdate">Data di Nascita *</label>
            <input name="birthdate" id="birthdate" type="date" required/>
        </fieldset>
        <br>
        <fieldset>
            <legend>Indirizzo</legend>
            <label for="address">Via/Piazza</label>
            <input name="address" id="address" type="text" size="40" maxlength="40" /> &nbsp;&nbsp;&nbsp;

            <label for="addressnum">N.</label>
            <input name="addressnum" id="addressnum" type="number" max="9999" size="4" maxlength="4" disabled />

            <br><br>

            <label for="city">Località</label> &nbsp;&nbsp;&nbsp;
            <input name="city" id="city" type="text" size="15" maxlength="15" disabled />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

            <label for="cap">CAP.</label>
            <input name="cap" id="cap" type="tel" pattern="^\d{5}$" placeholder="#####" title="Inserire 5 cifre da 00100 a 98168" size="5" maxlength="5" disabled />

            <br /><br />

            <label for="tel">Tel.</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <input name="tel" id="tel" type="tel" placeholder="(+/00)PPLLLNNNNNNN" pattern="((((\+|00)[1-9]{2})|0)?([1-9]{2,3}))([0-9]{6,10})" title="Inserire il numero di telefono nel formato (+|00)<pref. int.><pref. loc.><numero> oppure 0<pref. loc.><numero>" size="20"
                maxlength="20" disabled />
        </fieldset>
        <br>
        <fieldset>
            <legend>Autenticazione</legend>
            <label class="mandatory" for="email">E-mail *</label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <input name="email" id="email" type="email" size="32" maxlength="40" required/><br /><br />

            <label class="mandatory" for="pass">Password *</label> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <input name="pass" id="pass" type="password" title="Almeno 8 caratteri, una lettera maiuscola e un numero" pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9]).{8,}$" size="32" maxlength="40" required/><br /><br />

            <label class="mandatory" for="repass">Reinserisci password *</label>&nbsp;
            <input name="repass" id="repass" type="password" size="32" maxlength="40" onchange="checkPassword(this)" required/>
        </fieldset>
        <br>
        <input name="ok" id="ok" type="submit" value="Invia" formtarget="_blank" />
    </form>

    <script>
        $(document).ready(function() {
            const db = JSON.parse(localStorage.getItem('regionData'));

            const weakPass = new RegExp("^((?=.*[a-z]).{8,}|(?=.*[a-z])(?=.*[A-Z]).{8,})$");
            const mediumPass = new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9]).{8,}$");
            const strongPass = new RegExp("^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#\$%\^&\*]).{8,}$");

            let province = null;

            $('#address').focusout(function(ev) {
                if ($(this).val() != '') {
                    $(this).siblings('input').removeAttr('disabled');
                } else {
                    $(this).siblings('input').attr('disabled', 'disabled');
                }
            }).keydown(function(ev) {
                if (ev.keyCode == 9) { // pressione TAB
                    if ($(this).val() != '') {
                        $(this).siblings('input').removeAttr('disabled');
                    } else {
                        $(this).siblings('input').attr('disabled', 'disabled');
                    }
                }
            });

            $('#repass').change(function(ev) {
                if ($(this).val() != $('#pass').val()) {
                    $(this).val('').attr('placeholder', 'Password non coincidenti!').focus();
                }
            });

            $('#pass').on('input', function(ev) {
                $(this).removeClass(['weak', 'medium', 'strong']);

                if (strongPass.test($(this).val()))
                    $(this).addClass('strong');
                else if (mediumPass.test($(this).val()))
                    $(this).addClass('medium');
                else $(this).addClass('weak');
            });

            $('#region').change(function(ev) {
                // rimozione dei precedenti elementi del menu Provincia e Comune

                $('#state').html('<option value="-1" selected></option>');
                $('#town').html('<option value="-1" selected></option>');

                if ($(this).val() != '-1') {
                    province = db.regioni[Number.parseInt($(this).val())].province;

                    for (let provincia of province) {
                        $(document.createElement('option')).
                        val(provincia.code).
                        text(provincia.nome).
                        appendTo('#state');
                    }

                }
            });

            $('#state').change(function(ev) {
                // rimozione dei precedenti elementi del menu Comune

                $('#town').html('<option value="-1" selected></option>');

                if ($(this).val() != '-1') {

                    for (let provincia of province) {
                        if (provincia.code == $('#state').val()) {
                            for (let comune of provincia.comuni) {

                                $(document.createElement('option')).
                                val(comune.cap).
                                text(comune.nome).
                                appendTo('#town');
                            }
                            break; // non dobbiamo cercare oltre
                        }
                    }
                }
            });

            // finestra di riepilogo
            function recapWindow() {
                let data = new FormData(document.forms[0]);
                let w = window.open("", "Recap", "width=600, height=600");

                $(w.document.body).html(`<h1>Riepilogo dati utente: ${data.get('name')}</h1><br><br>\
            <table>\
                <tr><th align='left'>Genere:</th><td>${data.get('gender')=='male'?'Uomo':'Donna'}</td></tr>\
                <tr><th align='left'>Data e luogo di nascita:</th><td>${new Date(data.get('birthdate')).toLocaleDateString()}\
                    , ${data.get('town')} (${data.get('state').toUpperCase()}) - ${data.get('region')}</td></tr>\
                <tr><th align='left'>Indirizzo:</th><td>${data.get('address')} n. ${data.get('addressnum')}\
                    , ${data.get('cap')} ${data.get('city')}</td></tr>\
                <tr><th align='left'>N. telefonico:</th><td>${data.get('tel')}</td></tr>\
                <tr><th align='left'>Email:</th><td>${data.get('email')}</td></tr>\
            </table>`);

                // inibisce la navigazione verso la url inserita nell'attributo action della form
                return false;
            }
        });
    </script>

</body>

</html>